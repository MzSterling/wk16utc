name: wk16Utc App ci/cd

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
      id-token: write
      contents: read

env:
  python_version: 3.11
  IMAGE_NAME: portfolio
  AWS_REGION: us-east-1
  ACCOUNT_ID: ${{secrets.ACCOUNT_ID}}
  # ECR_REPO: $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/dev
  ECR_REPO: ${{ secrets.ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com/dev
  IMAGE_TAG: ${{ github.run_number }}
  #IMAGE_TAG: ${{ github.sha }}


jobs: 
    build:
        runs-on: ubuntu-latest
        steps: 
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v4  #install python on runner
              with:
                  python-version: ${{env.python_version}} # or $python_version
            - name: install pytest and dependencies # for code testing 
              run: pip install -r requirements.txt
            - name: unit test
              run: pytest test.py

            - name: Configure AWS credentials using OIDC
              uses: aws-actions/configure-aws-credentials@v2
              with:
                role-to-assume: ${{ secrets.ROLE_ARN }}
                aws-region: ${{ env.AWS_REGION }}

                    
            - name: Login to Amazon ECR
              id: login-ecr
              uses: aws-actions/amazon-ecr-login@v1

            - name: Build Docker image   # Build Docker image
              run: |
                docker build -t ${{ env.IMAGE_NAME }} .

            
            - name: Tag Docker image # Tag Docker image for ECR
              run: |
                 docker tag ${{ env.IMAGE_NAME }}:latest ${{ env.ECR_REPO }}:${{ env.IMAGE_TAG }}
            # docker tag ${{ env.IMAGE_NAME }}:latest ${{ env.ECR_REPO }}:latest
            # docker tag ${{ env.IMAGE_NAME }}:latest ${{ env.ECR_REPO }}:v2.0

          
            - name: Scan Docker image with Trivy     # Scan Docker image with Trivy
              uses: aquasecurity/trivy-action@master
              with:
                  image-ref: ${{ env.ECR_REPO }}:latest
                  format: table
                  exit-code: '1' # fail workflow on critical/high vulnerabilities
                  severity: CRITICAL,HIGH

           
            - name: Push Docker image to Amazon ECR  # Push Docker image to ECR
              run: |
                 docker push ${{ env.ECR_REPO }}:${{ env.IMAGE_TAG }}
            #    docker push ${{ env.ECR_REPO }}:latest

    ecs_deploy:
       needs: build
       runs-on: ubuntu-latest
       steps:
         - uses: actions/checkout@v4
         - name: Configure AWS credentials using OIDC
           uses: aws-actions/configure-aws-credentials@v2
           with:
            role-to-assume: ${{ secrets.ROLE_ARN }}
            aws-region: ${{ env.AWS_REGION }}
         - name: Render ECS task definition with new image
           id: taskdef
           uses: aws-actions/amazon-ecs-render-task-definition@v1
           with:
             task-definition: ecs-taskdef.json
             container-name: nginx
             image: ${{ env.ECR_REPO }}:${{ env.IMAGE_TAG }}

         - name: Deploy to ECS Service
           uses: aws-actions/amazon-ecs-deploy-task-definition@v1
           with:
             task-definition: ${{ steps.taskdef.outputs.task-definition }}
             cluster: nginx-fargate-cluster
             service: nginx-fargate-service
             wait-for-service-stability: true     



 
              



          
           
           
           




           
           
           
        
